{{- $caption := .Title -}}
{{- $class := "mx-auto my-0 rounded-md" -}}
{{- $url := urls.Parse .Destination -}}

{{/* https://github.com/gohugoio/hugo/pull/10666/files */}}
{{- $params := $url.Query -}}
{{- $lazyParam := $params.Get "lazy" -}}
{{- $lazy := .Page.Site.Params.enableImageLazyLoading | default true -}}
{{- if eq $lazyParam "false" -}}
    {{- $lazy = false  -}}
{{- end -}}
{{- if eq $lazyParam "true" -}}
    {{- $lazy = true  -}}
{{- end -}}

{{- $webpParam := $params.Get "webp" -}}
{{- $webp := .Page.Site.Params.enableImageWebp | default true -}}
{{- if eq $webpParam "false" -}}
    {{- $webp = false  -}}
{{- end -}}
{{- if eq $webpParam "true" -}}
    {{- $webp = true  -}}
{{- end -}}

{{- $lqipParam := $params.Get "lqip" -}}
{{- $lqip := .Page.Site.Params.enableImageLqip | default false -}}
{{- if eq $lqipParam "false" -}}
    {{- $lqip = false  -}}
{{- end -}}
{{- if eq $lqipParam "true" -}}
    {{- $lqip = true  -}}
{{- end -}}

{{- $file := $url.Path}}
{{- $img := .Page.Resources.GetMatch $file -}}
{{- if and (not $img) .Page.File -}}
    {{ $path := path.Join .Page.File.Dir $file }}
    {{- $img = resources.Get $path -}}
{{- end -}}

{{- with $img -}}
  {{ partial "picture.html" (dict "img" . "alt" $.Text "lazy" $lazy "webp" $webp "lqip" $lqip "class" $class) }}
{{- else -}}
  {{ if $lazy }}
    {{/* do not use lazy without dimensions */}}
    {{ warnf "Can't use lazy images for %s" .Destination }}
  {{ end }}
  <img src="{{ .Destination | safeURL }}" alt="{{ $.Text }}" class="{{ $class }}"/>
{{- end -}}